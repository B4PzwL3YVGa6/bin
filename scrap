#!/bin/mksh
#
# http://github.com/MitchWeaver/bin
#
# Dependencies: slop, ImageMagick, xclip
# 
# Screen Capture
#

# make sure the script isn't already running
if [ $(pgrep slop) ] ; then exit ; fi

if [ "$1" == "-h" ] || [ "$1" == "--help" ] ; then
    echo "Usage: -u (upload), -o (output path), -n (no crop)"
fi

if [ "$1" = "-o" ] ; then
    path=$2
elif [ "$2" = "-o" ] ; then
    path="$3"
else
    [ ! -d /tmp/scrap ] && mkdir /tmp/scrap
    [ -d /tmp/scrap ] && path="/tmp/scrap" || \
        { echo "Unable to write to /tmp directory." ; exit 1 ; }
fi
# elif [ -d ${HOME}/tmp ] ; then
    # path="${HOME}/tmp/scrap"


file="$path/screenshot-$(date +%Y\ %m\ %d\ %H:%M.%S).png"
quality=100

if [ "$1" = "-n" ] || [ "$2" = "-n" ] || [ "$3" = "-n" ] ; then
    import -quiet -silent -window root -quality $quality "$file"
else
    # TODO: make this posix
    read -r X Y W H <<< $(slop -q -o -f '%x %y %w %h') &&

    import -quiet -silent -window root -quality $quality -crop "$W"x"$H"+"$X"+"$Y" "$file"
fi
 
if [ "$1" = "-u" ] || [ "$2" = "-u" ] ; then
    curl -sF file=@"$file" https://0x0.st | xclip &&

    xclip -o
fi
